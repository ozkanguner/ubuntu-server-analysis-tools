# MikroTik Otomatik Cihaz Algılama ve Klasör Oluşturma
# Her yeni IP/hostname için otomatik klasör oluşturur

# Directory creation settings
$CreateDirs on
$DirCreateMode 0755
$FileCreateMode 0644

# Hostname temizleme ve friendly name oluşturma
# Örnek: sultanahmet-hotspot.trasst.com → SULTANAHMET-HOTSPOT
$template HostnameCleanup,"%fromhost:R,ERE,1,FIELD:^([^.]+).*--end%"

# IP tabanlı otomatik klasörleme için template
$template AutoDeviceTemplate,"/var/5651/%fromhost%/genel/%$year%-%$month%-%$day%.log"

# Hostname tabanlı otomatik klasörleme için template  
$template AutoHostnameTemplate,"/var/5651/%$HostnameCleanup%/genel/%$year%-%$month%-%$day%.log"

# Bilinen IP'ler için özel isimler (opsiyonel)
if $fromhost-ip == "92.113.42.3" then {
    /var/5651/SULTANAHMET-HOTSPOT/genel/%$year%-%$month%-%$day%.log
    stop
}

if $fromhost-ip == "92.113.42.253" then {
    /var/5651/MASLAK-HOTSPOT/genel/%$year%-%$month%-%$day%.log  
    stop
}

# MikroTik forward logları için otomatik algılama
if ($msg contains "forward:" and $msg contains "in:" and $msg contains "out:") then {
    # Eğer hostname varsa hostname kullan, yoksa IP kullan
    if ($fromhost != $fromhost-ip) then {
        ?AutoHostnameTemplate
    } else {
        ?AutoDeviceTemplate  
    }
    stop
}

# MikroTik ağ aralığındaki tüm cihazlar için otomatik klasörleme
if ($fromhost-ip startswith "92.113.42." or 
    $fromhost-ip startswith "172." or 
    $fromhost-ip startswith "192.168." or
    $fromhost-ip startswith "10.") then {
    # Hostname varsa hostname kullan
    if ($fromhost != $fromhost-ip) then {
        ?AutoHostnameTemplate
    } else {
        # IP kullan
        ?AutoDeviceTemplate
    }
    stop
}

# Diğer tüm cihazlar için genel otomatik klasörleme
if ($programname == "mikrotik" or $msg contains "forward:" or $msg contains "connection-state:") then {
    if ($fromhost != $fromhost-ip) then {
        ?AutoHostnameTemplate
    } else {
        ?AutoDeviceTemplate
    }
    stop
} 